<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인기 YouTube Shorts 검색기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
       /* (스타일은 이전과 동일) */
       .card {
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .loader {
            display: none;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .video-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .card-img-top {
            height: 180px;
            object-fit: cover;
        }
        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.85rem;
        }
        .stats span {
            display: flex;
            align-items: center;
        }
        .stats svg {
            margin-right: 4px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">인기 YouTube Shorts 검색기</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-12">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">검색 조건</h5>
                    </div>
                    <div class="card-body">
                        <form id="searchForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="min_views" class="form-label">최소 조회수</label>
                                    <input type="number" class="form-control" id="min_views" name="min_views" value="1000000" min="1000">
                                </div>
                                <div class="col-md-6">
                                    <label for="days_ago" class="form-label">최근 기간 (일)</label>
                                    <input type="number" class="form-control" id="days_ago" name="days_ago" value="3" min="1" max="30">
                                </div>
                                <div class="col-md-6">
                                    <label for="category_id" class="form-label">카테고리</label>
                                    <select class="form-select" id="category_id" name="category_id">
                                        {% for category in categories %}
                                        <option value="{{ category.id }}">{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="region_code" class="form-label">국가</label>
                                    <select class="form-select" id="region_code" name="region_code">
                                        {% for region in regions %}
                                        <option value="{{ region.code }}" {% if region.code == selected_region %}selected{% endif %}>{{ region.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="language" class="form-label">언어</label>
                                    <select class="form-select" id="language" name="language">
                                        {% for lang in languages %}
                                        <option value="{{ lang.code }}" {% if lang.code == selected_language %}selected{% endif %}>{{ lang.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="duration_max" class="form-label">최대 길이 (초)</label>
                                    <input type="number" class="form-control" id="duration_max" name="duration_max" value="60" min="15" max="180">
                                </div>
                                <div class="col-md-6">
                                    <label for="max_results" class="form-label">최대 결과 수</label>
                                    <input type="number" class="form-control" id="max_results" name="max_results" value="50" min="10" max="50">
                                </div>
                                <div class="col-md-6">
                                    <label for="keyword" class="form-label">키워드 (선택사항)</label>
                                    <input type="text" class="form-control" id="keyword" name="keyword" placeholder="검색할 키워드">
                                </div>
                                <div class="col-md-6">
                                    <label for="title_contains" class="form-label">제목 포함 (선택 사항)</label>
                                    <input type="text" class="form-control" id="title_contains" name="title_contains" placeholder="제목에 포함될 단어">
                                </div>
                                <div class="col-md-6">
                                    <label for="channel_filter" class="form-label">채널 ID 필터 (콤마로 구분, 선택 사항)</label>
                                    <input type="text" class="form-control" id="channel_filter" name="channel_filter" placeholder="채널 ID (콤마로 구분)">
                                </div>
                                <div class="col-12 mt-3">
                                    <div class="d-flex justify-content-between">
                                        <button type="button" id="saveSearchBtn" class="btn btn-success" style="width: 48%;">검색 설정 저장</button>
                                        <button type="button" id="loadSearchBtn" class="btn btn-info" style="width: 48%;">저장된 설정 불러오기</button>
                                    </div>
                                </div>
                                <div class="col-12 mt-3">
                                    <button type="submit" class="btn btn-primary w-100">검색</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="loader" id="loader"></div>

        <div class="row mt-4 mb-3" id="resultsHeader" style="display: none;">
            <div class="col-12">
                <div class="alert alert-success">
                    <h5 class="mb-0">검색 결과: <span id="resultCount">0</span>개의 인기 Shorts</h5>
                </div>
            </div>
        </div>

        <div class="video-container" id="results">
            </div>
    </div>

    <footer class="bg-dark text-white text-center py-3 mt-5">
        <div class="container">
            <p class="mb-0">&copy; 2025 인기 YouTube Shorts 검색기</p>
        </div>
    </footer>

    <script>
       document.addEventListener('DOMContentLoaded', function() {
            // 저장 버튼
            document.getElementById('saveSearchBtn').addEventListener('click', function() {
                const formData = {
                    min_views: document.getElementById('min_views').value,
                    days_ago: document.getElementById('days_ago').value,
                    category_id: document.getElementById('category_id').value,
                    region_code: document.getElementById('region_code').value,
                    language: document.getElementById('language').value,
                    duration_max: document.getElementById('duration_max').value,
                    max_results: document.getElementById('max_results').value,
                    keyword: document.getElementById('keyword').value,
                    title_contains: document.getElementById('title_contains').value,
                    channel_filter: document.getElementById('channel_filter').value
                };

                const now = new Date();
                const saveKey = `shorts_search_${now.toISOString().replace(/[:.]/g, '_')}`;

                let savedSearches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
                savedSearches.push({
                    key: saveKey,
                    name: `검색 ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`,
                    data: formData
                });

                if (savedSearches.length > 10) {
                    savedSearches = savedSearches.slice(-10);
                }

                localStorage.setItem('savedSearches', JSON.stringify(savedSearches));
                localStorage.setItem(saveKey, JSON.stringify(formData));

                alert('검색 설정이 저장되었습니다.');
            });
            // 불러오기
            document.getElementById('loadSearchBtn').addEventListener('click', function() {
                const savedSearches = JSON.parse(localStorage.getItem('savedSearches') || '[]');

                if (savedSearches.length === 0) {
                    alert('저장된 검색 설정이 없습니다.');
                    return;
                }

                const modalHTML = `
                    <div class="modal fade" id="loadSearchModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">저장된 검색 설정 불러오기</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="list-group">
                                        ${savedSearches.map((search, index) => `
                                            <button type="button" class="list-group-item list-group-item-action load-search-item"
                                                    data-key="${search.key}" data-index="${index}">
                                                ${search.name}
                                                <button class="btn btn-sm btn-danger float-end delete-search-btn"
                                                        data-index="${index}">삭제</button>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const existingModal = document.getElementById('loadSearchModal');
                if (existingModal) {
                    existingModal.remove();
                }
                document.body.insertAdjacentHTML('beforeend', modalHTML);

                const loadSearchModal = new bootstrap.Modal(document.getElementById('loadSearchModal'));
                loadSearchModal.show();

                document.querySelectorAll('.load-search-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        if (e.target.classList.contains('delete-search-btn')) {
                            return;
                        }

                        const key = this.getAttribute('data-key');
                        const formData = JSON.parse(localStorage.getItem(key) || '{}');
                        for (const field in formData) {
                            if (formData.hasOwnProperty(field)) {
                                document.getElementById(field).value = formData[field] || '';
                            }
                        }

                        loadSearchModal.hide();
                    });
                });

                // 삭제 버튼
                document.querySelectorAll('.delete-search-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();  // 이벤트 버블링 방지

                        const index = parseInt(this.getAttribute('data-index'));
                        const savedSearches = JSON.parse(localStorage.getItem('savedSearches') || '[]');

                        if (index >= 0 && index < savedSearches.length) {
                            const key = savedSearches[index].key;
                            localStorage.removeItem(key);  // 로컬 스토리지에서 해당 검색 설정 삭제

                            savedSearches.splice(index, 1);  // 배열에서 해당 검색 설정 제거
                            localStorage.setItem('savedSearches', JSON.stringify(savedSearches)); //업데이트된 배열 저장

                            this.closest('.list-group-item').remove(); // 삭제 버튼의 부모 요소인 list-group-item 제거

                            if (savedSearches.length === 0) {
                                loadSearchModal.hide(); // 만약 더 이상 저장된 설정이 없으면 모달 닫기
                                alert('모든 저장된 검색 설정이 삭제되었습니다.');
                            }
                        }
                    });
                });
            });

            // 마지막 검색 로드 (페이지 로드 시)
            const lastSearch = localStorage.getItem('lastSearch');
            if (lastSearch) {
                const formData = JSON.parse(lastSearch);
                for (const field in formData) {
                  if(formData.hasOwnProperty(field)){
                    document.getElementById(field).value = formData[field] || '';
                  }
                }
            }
       });


        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();

            document.getElementById('loader').style.display = 'block';
            document.getElementById('results').innerHTML = ''; // 결과 초기화
            document.getElementById('resultsHeader').style.display = 'none';

            const formData = new FormData(this);

            fetch('/search', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loader').style.display = 'none';

                if (data.status === 'success') {
                    document.getElementById('resultsHeader').style.display = 'block';
                    document.getElementById('resultCount').textContent = data.count;

                    const resultsContainer = document.getElementById('results');
                    if (data.results.length === 0) {
                        resultsContainer.innerHTML = '<div class="col-12"><div class="alert alert-warning">검색 조건에 맞는 결과가 없습니다.</div></div>';
                        return;
                    }

                    // 결과 동적 생성 (AJAX 방식)
                    let resultsHTML = '';
                    data.results.forEach(video => {
                        resultsHTML += `
                            <div class="card h-100">
                                <a href="<span class="math-inline">\{video\.url\}" target\="\_blank"\>
<img src\="</span>{video.thumbnail}" class="card-img-top" alt="<span class="math-inline">\{video\.title\}"\>
</a\>
<div class\="card\-body"\>
<h6 class\="card\-title"\></span>{video.title}</h6>
                                    <p class="card-text small text-muted">${video.channelTitle}</p>
                                    <div class="stats">
                                        <span>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                                                <path d="M8 2a6 6 0 1 1 0 12A6 6 0 0 1 8 2zm0 1a5 5 0 1 0 0 10A5 5 0 0 0 8 3z"/>
                                                <circle cx="8" cy="7.5" r="2.5"/>
                                            </svg>
                                            ${formatNumber(video.viewCount)}
                                        </span>
                                        <span>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-hand-thumbs-up" viewBox="0 0 16 16">
                                                <path d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2.144 2.144 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a9.84 9.84 0 0 0-.443.05 9.365 9.365 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111L8.864.046zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a8.908 8.908 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.224 2.224 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.866.866 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"/>
                                            </svg>
                                            ${formatNumber(video.likeCount)}
                                        </span>
                                        <span>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat" viewBox="0 0 16 16">
                                                <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                                            </svg>
                                            ${formatNumber(video.commentCount)}
                                        </span>
                                    </div>
                                    <div class="mt-2 small text-muted">
                                        <span>${formatDate(video.publishedAt)}</span> • <span>${video.duration}초</span>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <a href="${video.url}" target="_blank" class="btn btn-sm btn-primary w-100">쇼츠 보기</a>
                                </div>
                            </div>
                        `;
                    });
                    resultsContainer.innerHTML = resultsHTML;


                } else {
                    document.getElementById('resultsHeader').style.display = 'block';
                    document.getElementById('resultCount').textContent = '0';
                    document.getElementById('results').innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger">
                                <h5 class="mb-0">오류 발생</h5>
                                <p class="mb-0">${data.message}</p>
                            </div>
                        </div>
                    `;
                }

              // 마지막 검색 저장 (fetch 성공/실패 여부와 관계없이)
                const lastSearchData = {};
                for (let [key, value] of formData.entries()) {
                    lastSearchData[key] = value;
                }
                localStorage.setItem('lastSearch', JSON.stringify(lastSearchData));

            })
            .catch(error => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('resultsHeader').style.display = 'block';
                document.getElementById('resultCount').textContent = '0';
                document.getElementById('results').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <h5 class="mb-0">네트워크 오류</h5>
                            <p class="mb-0">${error.message}</p>
                        </div>
                    </div>
                `;
            });
        });

         // 숫자 포맷 함수 (JavaScript)
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + "M";
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + "K";
            }
            return num.toString();
        }

        // 날짜 포맷 함수 (JavaScript)
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString(); // YYYY-MM-DD 형식
        }


    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
                                                